name: DevSecOps CI/CD

on:
  push:
    branches: [ "feat/exam-test" ]

permissions:
  contents: read
  id-token: write
  packages: write
  security-events: write

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: devops-test
  IMAGE_TAG: ${{ github.sha }}
  K8S_NAMESPACE: dev
  DEPLOYMENT_NAME: devops-test-app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}
      image_repo: ${{ steps.build.outputs.image_repo }}
      image_digest: ${{ steps.build.outputs.image_digest }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --no-interaction --no-ansi

      - name: Run pytest
        run: |
          poetry run pytest -q

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${PROJECT_NAME}"
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $REPO

      - name: Build & Push Docker Image
        id: build
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          IMAGE_REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${PROJECT_NAME}"
          IMAGE_URI="${IMAGE_REPO}:${IMAGE_TAG}"

          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

          # Get digest AFTER pushing
          IMAGE_DIGEST=$(aws ecr describe-images \
            --repository-name ${PROJECT_NAME} \
            --image-ids imageTag=${IMAGE_TAG} \
            --query 'imageDetails[0].imageDigest' \
            --output text)

          echo "Image Repo: $IMAGE_REPO"
          echo "Image pushed with digest: ${IMAGE_DIGEST}"

          # Export outputs for next job
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "image_digest=${IMAGE_DIGEST}" >> $GITHUB_OUTPUT
          echo "image_repo=${IMAGE_REPO}" >> $GITHUB_OUTPUT

  security:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${PROJECT_NAME}"
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $REPO

      # SAST with Semgrep
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run SAST (Semgrep)
        continue-on-error: true
        run: |
          semgrep --config=p/ci --severity=ERROR --sarif --output semgrep.sarif

      # Secret Scanning with Gitleaks
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        with:
          args: detect --redact --report-format sarif --report-path gitleaks.sarif

      # Vulnerability Scanning with Trivy - Filesystem
      - name: Generate Trivy FS Vulnerability Report
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          output: trivy-fs.json
          format: json
          scan-ref: .
          exit-code: 0

      - name: Upload FS Vulnerability Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: trivy-fs.json
          retention-days: 7

      - name: Fail FS scan on HIGH/CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          format: table
          scan-ref: .
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          skip-setup-trivy: true

      # Vulnerability Scanning with Trivy - Container Image
      - name: Generate Trivy Image Vulnerability Report
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ needs.build.outputs.image_uri }}
          output: trivy-image.json
          format: json
          exit-code: 0

      - name: Upload Image Vulnerability Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image.json
          retention-days: 7

      - name: Fail Image scan on HIGH/CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ needs.build.outputs.image_uri }}
          format: table
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: 1
          skip-setup-trivy: true

      # Merge and Upload Reports
      - name: Merge SARIF results
        uses: microsoft/sarif-tools@v3
        with:
          command: merge
          input-files: |
            semgrep.sarif
            gitleaks.sarif
          output-file: combined.sarif

      - name: Upload merged SARIF to code scanning
        uses: github/code-scanning/upload-sarif@v3
        with:
          sarif_file: combined.sarif

      - name: Upload All Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            semgrep.sarif
            gitleaks.sarif
            trivy-fs.json
            trivy-image.json
            combined.sarif

      # Container Image Signing with Cosign
      - name: Install Cosign
        run: |
          curl -sSL -o /usr/local/bin/cosign \
            https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
          chmod +x /usr/local/bin/cosign

      - name: Keyless Sign Container Image
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          IMAGE="${{ needs.build.outputs.image_repo }}@${{ needs.build.outputs.image_digest }}"
          echo "Signing image: $IMAGE"
          cosign sign --yes "$IMAGE"